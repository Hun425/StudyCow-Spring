DELIMITER //
-- 1. 일일 유저 공부시간 정산
CREATE PROCEDURE P_DAILY_USER_STUDY(IN V_PROC_DATE DATE)
BEGIN
	CREATE TEMPORARY TABLE TEMP_USER_STUDY AS
    SELECT
		USER_ID,
        STUDY_DATE AS PROC_DATE,
        SUM(STUDY_TIME) AS SUM_STUDY_TIME
	FROM T_IN_LOG
    WHERE STUDY_DATE = V_PROC_DATE
    GROUP BY USER_ID, STUDY_DATE;

	INSERT INTO T_PROC_USER_STUDY(USER_ID, PROC_DATE, SUM_STUDY_TIME)
    SELECT USER_ID, PROC_DATE, SUM_STUDY_TIME FROM TEMP_USER_STUDY
    ON DUPLICATE KEY UPDATE SUM_STUDY_TIME = VALUES(SUM_STUDY_TIME);
    
    DROP TEMPORARY TABLE TEMP_USER_STUDY;
END //


DELIMITER //
-- 2. 일일 방 공부시간 정산
CREATE PROCEDURE P_DAILY_ROOM_STUDY(IN V_PROC_DATE DATE)
BEGIN
	CREATE TEMPORARY TABLE TEMP_ROOM_STUDY AS
    SELECT
		ROOM_ID,
        STUDY_DATE AS PROC_DATE,
        SUM(STUDY_TIME) AS SUM_ROOM_TIME
	FROM T_IN_LOG
    WHERE STUDY_DATE = V_PROC_DATE
    GROUP BY ROOM_ID, STUDY_DATE;

	INSERT INTO T_PROC_ROOM_STUDY(ROOM_ID, PROC_DATE, SUM_ROOM_TIME)
    SELECT ROOM_ID, PROC_DATE, SUM_ROOM_TIME FROM TEMP_ROOM_STUDY
    ON DUPLICATE KEY UPDATE SUM_ROOM_TIME = VALUES(SUM_ROOM_TIME);
    
    DROP TEMPORARY TABLE TEMP_ROOM_STUDY;
END //

DELIMITER //
-- 0. 일일 정산프로시저 호출
CREATE PROCEDURE P_DAILY_CALL_PROCEDURE(IN V_PROC_DATE DATE)
BEGIN
	START TRANSACTION;
	-- 1. 유저 일일 공부시간 정산
    CALL P_DAILY_USER_STUDY(V_PROC_DATE);
    
    -- 2. 방 일일 공부시간 정산
    CALL P_DAILY_ROOM_STUDY(V_PROC_DATE);
    
    -- 3. 정산 후 등급별 EXP 부여(예정)
    
    
    COMMIT;
END //

