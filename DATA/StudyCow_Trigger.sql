DELIMITER //
-- 방 입장 log 입력 시 방 참여유저 insert, 방 인원 수 최신화
CREATE TRIGGER TRG_BEFORE_INSERT_IN_LOG
BEFORE INSERT ON T_IN_LOG
FOR EACH ROW
BEGIN
	DECLARE V_USER_ID INT;
    DECLARE V_ROOM_ID bigint;
    DECLARE V_ROOM_CNT INT;
    DECLARE V_ROOM_MAX_PERSON INT;
    DECLARE V_ROOM_NOW_PERSON INT;
    
    SET V_USER_ID = NEW.USER_ID;
    SET V_ROOM_ID = NEW.ROOM_ID;
    
    -- 참석하려는 방의 최대정원과 현 인원 수 조회
    SELECT ROOM_MAX_PERSON, ROOM_NOW_PERSON
    INTO V_ROOM_MAX_PERSON, V_ROOM_NOW_PERSON
    FROM T_ROOM
    WHERE ROOM_ID = V_ROOM_ID;
    
    -- 방 인원이 다 찼을 경우 EXCEPTION 발생
    IF V_ROOM_NOW_PERSON >= V_ROOM_MAX_PERSON THEN
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '방 정원이 초과되었습니다. 입장할 수 없습니다.';
	END IF;
    
    -- 정산일자를 06:00 기준으로 업데이트 하기위한 STUDY_DATE
    IF NEW.IN_DATE - INTERVAL 6 HOUR < current_date() THEN
		SET NEW.STUDY_DATE = current_date() - interval 1 day;
	ELSE 
		SET NEW.STUDY_DATE = current_date();
    END IF;
    
    -- 참석자 정보 조회 후 없을 경우 INSERT 처리
	IF NOT EXISTS (
        SELECT 1 
        FROM T_ATTEND 
        WHERE USER_ID = V_USER_ID AND ROOM_ID = V_ROOM_ID
    ) THEN
        INSERT INTO T_ATTEND (USER_ID, ROOM_ID) 
        VALUES (V_USER_ID, V_ROOM_ID);
    END IF;
    
    SELECT COUNT(*) 
    INTO V_ROOM_CNT 
    FROM T_ATTEND 
    WHERE ROOM_ID = V_ROOM_ID;
    
    -- 현재 참석중인 인원 수 업데이트
    UPDATE T_ROOM 
    SET ROOM_NOW_PERSON = V_ROOM_CNT,
    ROOM_UPDATE_DATE = NOW()
    WHERE ROOM_ID = NEW.ROOM_ID;
END //


DELIMITER //
-- 방 입장 log 퇴장 시 방 참여유저 delete, 방 인원 수 최신화
CREATE TRIGGER TRG_AFTER_UPDATE_IN_LOG
AFTER UPDATE ON T_IN_LOG
FOR EACH ROW
BEGIN
	DECLARE V_OUT_DATE DATETIME(6);
    DECLARE V_USER_ID INT;
	DECLARE V_ROOM_ID BIGINT;
	DECLARE V_ROOM_CNT INT;
        
    SET V_OUT_DATE = NEW.OUT_DATE;
    
    -- out_date가 업데이트되고 기존 out_date와 현 out_date가 다를 경우 trigger 실행
    IF V_OUT_DATE IS NOT NULL AND (OLD.OUT_DATE IS NULL OR V_OUT_DATE <> OLD.OUT_DATE) THEN
		SET V_USER_ID = OLD.USER_ID;
		SET V_ROOM_ID = OLD.ROOM_ID;
        
        DELETE FROM T_ATTEND
        WHERE USER_ID = V_USER_ID AND ROOM_ID = V_ROOM_ID;
        
		SELECT COUNT(*) 
		INTO V_ROOM_CNT 
		FROM T_ATTEND 
		WHERE ROOM_ID = V_ROOM_ID;
		
		UPDATE T_ROOM 
		SET ROOM_NOW_PERSON = V_ROOM_CNT,
        ROOM_UPDATE_DATE = NOW()
		WHERE ROOM_ID = NEW.ROOM_ID;
    
    END IF;
END //

DELIMITER //
-- exp 부여 시 user정보 동기화
CREATE TRIGGER TRG_AFTER_INSERT_EXP_LOG
AFTER INSERT ON T_EXP_LOG
FOR EACH ROW
BEGIN
    DECLARE V_USER_ID INT;
    DECLARE V_NOW_GRADE INT;
    DECLARE V_USER_EXP INT;
    DECLARE V_GRADE_CODE INT;
	
    SET V_USER_ID = NEW.USER_ID;
    
    -- 부여된 exp만큼 user_exp 증가
    UPDATE T_USER SET USER_EXP = USER_EXP + NEW.GET_AMOUNT
    WHERE USER_ID = V_USER_ID;
    
    -- 증가 후 현재 exp와 등급 조회
    SELECT GRADE_CODE, USER_EXP INTO V_NOW_GRADE, V_USER_EXP
    FROM T_USER
    WHERE USER_ID = V_USER_ID;
    
    -- 현 exp에 맞는 등급 조회
    SELECT GRADE_CODE INTO V_GRADE_CODE FROM T_GRADE_CODE
    WHERE V_USER_EXP BETWEEN MIN_EXP AND MAX_EXP;
    
    -- 등급변동이 있을 경우 유저정보 동기화
    IF V_GRADE_CODE <> V_NOW_GRADE THEN
		UPDATE T_USER SET GRADE_CODE = V_GRADE_CODE
        WHERE USER_ID = V_USER_ID;
    END IF;
    
END //