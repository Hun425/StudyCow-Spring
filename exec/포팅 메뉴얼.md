# StudyCow ~공부했소?~
포팅 메뉴얼 (수동 배포 기준)

## 목차
I. 개요
1. 프로젝트 개요
2. 프로젝트 사용 도구
3. 개발환경
4. 외부 서비스

II. 환경 구성
1. AWS EC2 설정
2. Docker 설치 및 설정
3. 환경 변수 설정
4. 네트워크 구성

III. 서비스별 빌드 및 배포
1. Backend
2. Frontend
3. Nginx (SSL 설정 포함)
4. OpenVidu
5. Grafana
6. Prometheus
7. Redis
8. Jenkins

IV. 서비스 구동 및 관리
1. 컨테이너 관리
2. 서비스 실행 확인
3. 로그 확인 및 트러블슈팅

V. 외부 서비스 연동
1. OpenAI API 설정
2. Google Cloud Storage 설정
3. OpenVidu 설정

VI. 유지보수 및 모니터링
1. 컨테이너 업데이트
2. 백업 및 복구
3. 성능 모니터링
4. SSL 인증서 관리

VII. 트러블슈팅
1. 일반적인 문제 해결
2. 서비스별 문제 해결

VIII. 시연 시나리오
1. 영상 시나리오

## I. 개요

### 1. 프로젝트 개요

StudyCow는 성적 관리 및 동기 부여가 필요한 학생을 위한 통합 서비스입니다. 주요 기능으로는 온라인 그룹 스터디를 위한 캠 스터디, 손 감지 타이머 기능, 자율 학습 관리를 위한 플래너, 성적 기반 자동 생성 기능, 게이미피케이션 & 랭킹 기능, 개인 맞춤형 학습 플랜 추천 등이 있습니다.

### 2. 프로젝트 사용 도구

- 이슈 관리: JIRA
- 형상 관리: GitLab
- 커뮤니케이션: Discord, Notion
- 디자인: Figma
- 컨테이너화: Docker

### 3. 개발환경

- Front-end:
  - Node.js: v20 (Alpine)
  - React with Vite
  - IDE: VS Code 1.92.1
- Back-end:
  - Java: JDK 17
  - Spring Boot
  - IDE: IntelliJ IDEA 2024.1 Ultimate
- Database: MySQL 8.0
- Cache: Redis 7.4.0
- Server: AWS EC2 Ubuntu 20.04.3 LTS
- 컨테이너화: Docker

### 4. 외부 서비스

- OpenAI API: AI 기반 학습 플랜 추천
- Google Cloud Storage: 파일 저장소
- OpenVidu: 화상 스터디 기능

## II. 환경 구성

### 1. AWS EC2 설정

- EC2 인스턴스 유형: t2.medium (또는 프로젝트에 적합한 유형)
- OS: Ubuntu 20.04 LTS
- 보안 그룹 설정:
  - SSH (22 포트)
  - HTTP (80 포트)
  - HTTPS (443 포트)
  - 애플리케이션 포트 (8080, 3000, 3333, 9999, 6379, 9090, 50001 등)

### 2. Docker 설치 및 설정

EC2 인스턴스에 Docker 설치:
```bash
sudo apt update
sudo apt install docker.io
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -aG docker ${USER}
```

Docker Compose 설치:
```bash
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 3. 환경 변수 설정

프로젝트 루트 디렉토리에 `.env` 파일을 생성하고 다음 내용을 추가 or intellij의 환경변수에 직접 등록

```
GPT_API_KEY=your_openai_api_key
VITE_API_BASE_URL=https://i11c202.p.ssafy.io/studycow/
SPRING_PROFILES_ACTIVE=prod
OPENVIDU_SECRET=your_openvidu_secret
TZ=Asia/Seoul
```


### 4. 네트워크 구성

Docker 네트워크 생성:
```bash
docker network create studycow_network
```

## III. 서비스별 빌드 및 배포

### 1. Backend

1. 프로젝트 디렉토리로 이동:
   ```bash
   cd backend
   ```

2. Gradle을 사용하여 프로젝트 빌드:
   ```bash
   ./gradlew clean bootJar
   ```

3. Dockerfile 생성:
   ```Dockerfile
   FROM openjdk:17-jdk-slim
   ARG JAR_FILE=build/libs/*.jar
   COPY ${JAR_FILE} app.jar
   ENTRYPOINT ["java","-jar","/app.jar"]
   ```

4. Docker 이미지 빌드:
   ```bash
   docker build -t backend:latest .
   ```

5. 백엔드 컨테이너 실행:
   ```bash
   docker run -d --name backend \
       --network studycow_network \
       -p 8080:8080 \
       -e SPRING_PROFILES_ACTIVE=prod \
       -e GPT_API_KEY=${GPT_API_KEY} \
       -e OPENVIDU_SECRET=${OPENVIDU_SECRET} \
       -e TZ=Asia/Seoul \
       backend:latest
   ```

### 2. Frontend

1. 프로젝트 디렉토리로 이동:
   ```bash
   cd studycow
   ```

2. 의존성 설치 및 프로젝트 빌드:
   ```bash
   npm install
   npm run build
   ```

3. Dockerfile 생성:
   ```Dockerfile
   FROM nginx:alpine
   COPY build/ /usr/share/nginx/html
   EXPOSE 80
   CMD ["nginx", "-g", "daemon off;"]
   ```

4. Docker 이미지 빌드:
   ```bash
   docker build -t frontend:latest .
   ```

5. 프론트엔드 컨테이너 실행:
   ```bash
   docker run -d --name frontend \
       --network studycow_network \
       -p 3000:80 \
       -e TZ=Asia/Seoul \
       frontend:latest
   ```

### 3. Nginx (SSL 설정 포함)

1. Nginx 설정 파일 (`nginx.conf`) 생성:
   ```nginx
   events {
       worker_connections 1024;
   }

   http {
       upstream backend {
           server backend:8080;
       }

       upstream frontend {
           server frontend:80;
       }

       server {
           listen 80;
           server_name i11c202.p.ssafy.io;
           
           location / {
               return 301 https://$host$request_uri;
           }

           location /.well-known/acme-challenge/ {
               root /var/www/certbot;
           }
       }

       server {
           listen 443 ssl;
           server_name i11c202.p.ssafy.io;

           ssl_certificate /etc/letsencrypt/live/i11c202.p.ssafy.io/fullchain.pem;
           ssl_certificate_key /etc/letsencrypt/live/i11c202.p.ssafy.io/privkey.pem;

           location /studycow/api {
               proxy_pass http://backend;
               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
           }

           location /studycow {
               proxy_pass http://frontend;
               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
           }
       }
   }
   ```

2. Dockerfile 생성:
   ```Dockerfile
   FROM nginx:alpine
   RUN mkdir -p /var/www/certbot
   COPY nginx.conf /etc/nginx/nginx.conf
   EXPOSE 80 443
   ```

3. Docker 이미지 빌드:
   ```bash
   docker build -t nginx-ssl:latest .
   ```

4. Nginx 컨테이너 실행:
   ```bash
   docker run -d --name nginx-ssl \
       --network studycow_network \
       -p 80:80 -p 443:443 \
       -v /etc/letsencrypt:/etc/letsencrypt \
       -v /var/www/certbot:/var/www/certbot \
       nginx-ssl:latest
   ```

5. SSL 인증서 발급 (Certbot 사용):
   ```bash
   docker run -it --rm --name certbot \
       -v /etc/letsencrypt:/etc/letsencrypt \
       -v /var/www/certbot:/var/www/certbot \
       certbot/certbot certonly --webroot \
       -w /var/www/certbot \
       -d i11c202.p.ssafy.io
   ```

6. Nginx 설정 리로드:
   ```bash
   docker exec nginx-ssl nginx -s reload
   ```

### 4. OpenVidu

1. OpenVidu 설치 스크립트 다운로드 및 실행:
   ```bash
   curl https://s3-eu-west-1.amazonaws.com/aws.openvidu.io/install_openvidu_latest.sh | bash
   ```

2. 설정 파일 수정:
   ```bash
   nano /opt/openvidu/.env
   ```
   필요한 설정을 변경 (예: DOMAIN_OR_PUBLIC_IP, OPENVIDU_SECRET 등)

3. OpenVidu 실행:
   ```bash
   cd /opt/openvidu
   ./openvidu start
   ```

### 5. Grafana

1. Grafana 컨테이너 실행:
   ```bash
   docker run -d --name grafana \
       --network studycow_network \
       -p 3333:3000 \
       grafana/grafana:latest
   ```

2. 웹 브라우저에서 `http://your-ip:3333`로 접속하여 초기 설정 진행

### 6. Prometheus

1. Prometheus 설정 파일 (`prometheus.yml`) 생성:
   ```yaml
   global:
     scrape_interval: 15s

   scrape_configs:
     - job_name: 'spring-actuator'
       metrics_path: '/studycow/actuator/prometheus'
       static_configs:
         - targets: ['backend:8080']
   ```

2. Prometheus 컨테이너 실행:
   ```bash
   docker run -d --name prometheus \
       --network studycow_network \
       -p 9999:9090 \
       -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml \
       prom/prometheus:latest
   ```

### 7. Redis

Redis 컨테이너 실행:
```bash
docker run -d --name studycow-redis \
    --network studycow_network \
    -p 6379:6379 \
    redis:latest
```

### 8. Jenkins

1. Jenkins Dockerfile 생성:
   ```Dockerfile
   FROM jenkins/jenkins:lts
   USER root
   RUN apt-get update && apt-get install -y docker.io
   USER jenkins
   ```

2. Jenkins 이미지 빌드:
   ```bash
   docker build -t newjenkins .
   ```

3. Jenkins 컨테이너 실행:
   ```bash
   docker run -d --name jenkins \
       --network studycow_network \
       -p 9090:8080 -p 50001:50000 \
       -v jenkins_home:/var/jenkins_home \
       -v /var/run/docker.sock:/var/run/docker.sock \
       newjenkins
   ```

4. Jenkins 초기 비밀번호 확인:
   ```bash
   docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword
   ```

5. 웹 브라우저에서 `http://your-ip:9090`로 접속하여 Jenkins 초기 설정 진행

## IV. 서비스 구동 및 관리

### 1. 컨테이너 관리

컨테이너 상태 확인:
```bash
docker ps
```

컨테이너 중지:
```bash
docker stop [container_name]
```

컨테이너 시작:
```bash
docker start [container_name]
```

### 2. 서비스 실행 확인

각 서비스의 상태를 확인:

1. 백엔드 상태 확인:
   ```bash
   curl -f http://localhost:8080/studycow/actuator/health
   ```

2. 프론트엔드 상태 확인:
   ```bash
   curl -f http://localhost:3000
   ```

3. Nginx 상태 확인:
   ```bash
   curl -f -k https://i11c202.p.ssafy.io/studycow
   ```

### 3. 로그 확인 및 트러블슈팅

컨테이너 로그 확인:
```bash
docker logs [container_name]
```

실시간 로그 확인:
```bash
docker logs -f [container_name]
```

## V. 외부 서비스 연동

### 1. OpenAI API 설정

백엔드의 `application.yml`에 다음 설정을 추가:
```yaml
openai:
  model:
```


